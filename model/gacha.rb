#!/usr/bin/ruby -Ku
# -*- coding: utf-8 -*-

class Gacha

def initialize(probability)
	
	@probability = probability

end


def self.get_gacha(gacha_id, sql)

	statement = sql.prepare("select monster_id, probability from gacha_probability where gacha_id = ? order by 'probability' desc")
	result_tmp = statement.execute(gacha_id)
	
	result = []
	result_tmp.each do |row|

		result << row
				
	end

	probability= {}
	result.each do |row|
	
		id = row["monster_id"]
		pro = row["probability"]
	
		probability.store(id, pro)
	
	end

	gacha = Gacha.new(probability)

	return gacha

end


# é««ï½¨†ïï½ï½½ï½ï½½é©›ï½¢ï½ï½§ï½ï½ï½¬é©›ï½¢è­ï½¶ˆšï¾å–…•ï½ï½¸ï½ï½ºï½ï½ï½®é©›ï½¢ï½ï½§ï½ï½ï½¢é©›ï½¢è­Žï½¢ï½ï½½ï½ï½«é©›ï½¢ï½ï½§ï½ï½ï½´é©›ï½¢è­Žï½¢ï½ï½½ï½ï½ªé©›ï½¢ï½ï½§ï½ï½ï½ºé©›ï½¢è¬«å¸ï½«ï½«ï½ï½±ï½ï½ï½¬é««ï½´è Žï½¶
# é©ï½µï½ï½²€é©•ï½¶ï½ï½­ é¬©å¢“æ…£ï½ï½½ï½ï½ºé¬©é˜ªå¯’é–­ï½¥ï½ï½¼ƒçï½ï½¸ï½ï½ºï½ï½ï½¨é©ï½µï½ï½ºï½ï½ï½«rangeé©›ï½¢ï½ï½§é™žï½³èžŸï½²ï½ï½½ï½ï½¨ï½ï½ï½­é«¯æ©¸ï½½ï½³é™žï½¢ï½ï½¹€‚
# é©ï½µï½ï½²€é©ï½µï½ï½²€é©ï½µï½ï½ºé«¦ï½®èœƒï½µï½ï½®é©ï½µï½ï½ºï½ï½ï½¨é©ï½µï½ï½ºé«¢ï½§ï½ï½´˜‡é¬¯ï½¯††é–¨ï½¹†“é«£åŒ…ï½½ï½³ï½ï½ï½¦é©ï½µï½ï½ºï½ï½ï½¶&é¬©å¢“æ…£ï½ï½½ï½ï½ºé¬©åŒ…ï½½ï½¶é™·ï½¿ï½ï½¥€ï½ï½ï½¤é©ï½µï½ï½ºéš°ç–²ï½ºï½·ˆˆé¬©é˜ªï½‡èŸ·ï½²ï¼†çï½ï½¹ï½ï½§é™Ÿå‹Ÿï½¨ï½¯€ï½ï½»é©ï½µï½ï½º„ãï¿ï½ï½¥é©ï½µï½ï½²‚
# é©ï½µï½ï½²€é©•ï½¶ï½ï½­ï½ï½ï½¡é¬©å¢“æ…£ï½ï½½ï½ï½ºé¬©é˜ªå¯’éš˜ƒïï½½ï½½ï½ï½¸ï½ï½ï½¯é©ï½µï½ï½ºï½ï½ï½§é«£åŒ…ï½½ï½µï½ï½ï½±é««ï½°ï½ï½¨ï½ï½ï½°é¬¨ï½¾èœˆï½·ï½ï½½ï½ï½ºé¬®ï½¯ï½ï½¦é™Ÿå‹Ÿï½¨ï½¯˜†é©›ï½¢ï½ï½§é—•ï½µè¬ï½©‚
# é©ï½µï½ï½²€é©•ï½¶ï½ï½­ï½ï½ï½¢é©•ï½¶ï½ï½­ é©ï½µï½ï½ºï½ï½ï½®rangeé©ï½µï½ï½ºï½ï½ï½«é«´è¶£ï½½ï½£ï½ï½ï½§é«¯ï½·ï½ï½·é«£é¯‰ï½½ï½¨ï½ï½ï½¼ˆrand < range_maxï¼é™ï½²ï½ï½¨ï¼ é©ï½µï½ï½ºï½ï½ï½¦é©ï½µï½ï½º„ãï¿ï½ï½¥é©ï½µï½ï½²‚
# é©ï½µï½ï½²€é©ï½µï½ï½²€é©•ï½¶ï½ï½­ é©ï½µï½ï½ºï½ï½ï½¯é««ï½´é¬††éï½¬††sortedé©ï½µï½ï½ºï½ï½ï½®é©ï½µï½ï½ºé›‹…åâˆžï½ï½½ç«ï½«ï½ï½¸ï½ï½²é¶æ“¾ï½½ï½µéš²ï½¤èœ»ï½µèŸ æˆŠï½­æ“¾ï½½ï½´é¶ä¼€èš¤ngeé©ï½µï½ï½ºï½ï½ï½«é«¯ï½·ï½ï½·é¬©å¸šˆžï½ï½´é©ï½µï½ï½ºé™·ï½·ï½ï½¶ï½éï½§onsteré©›ï½¢ï½ï½§é«®åŒºï½©ï½¸ï½ï½½ï½ï½½é¬¯ï½¥ï½ï½´é¶å‰°ã”ï½ï½¸ï½ï½ºï½ï½ï½¨é©ï½µï½ï½ºé™·ï½·ï½ï½¶ï½è®™è¶£ï½½ï½¸ï½ï½ºï½ï½ï½°é¬®ï½«é™¬æ‡ˆˆ–ï½ï½ï½»ï½ï½ï½¶é©›ï½¢ï½ï½§é™·ï½»é—Œï½¨ï½ï½½ï½ï½º€é¬®ï½®è«›ï½¶ï½ï½½ï½ï½³é©ï½µï½ï½ºé™·ï½·ï½ï½¶ï½è¿¢æš¦ï½½ï½¸ï½ï½²‚
def execute_gacha()
	
	probability_range = {}
	range_tmp = 0 
	@probability.each do |key,val|
		
		val += range_tmp
		
		probability_range.store(key, val)
		
		range_tmp = val
	
	end

	# lasté©ï½µï½ï½ºé«£æ‚Ÿï½¿æ´‹é©ï½µï½ï½ºï½ï½ï½¨é«£åŒ…ï½½ï½³€é¬®ï½¢ï½ï½¾ï½ï½ï½´é©ï½µï½ï½ºé™·ï½·ï½ï½¶ï½è¿¢æš¦ï½½ï½¸ï½ï½ºï½ï½ï½®é©ï½µï½ï½ºï½ï½ï½§lasté«¯åŒºï½»ã‚‘ï½½ï½½ï½ï½¤é©ï½µï½ï½ºï½ï½ï½¨é«®çƒ€é©ï½µï½ï½ºé›‹…å€ï½ª˜†é©ï½µï½ï½ºï½ï½ï½¹é©ï½µï½ï½ºé™·ï½¥ï½ï½²ï½ï½ï½¢ï½ï½ï½ºé¬©é˜ªå¯’é™¬ï½¼ï½ï½²éï½©è®æ‰‹æ»‹ï½ï½¥€ï½ï½ï½¤é©›ï½¢ï½ï½§é™·ï½»é—Œï½¨ï½ï½½ï½ï½¯é©•å‘ˆæ±šï½ï½½ï½ï½¼ƒ
	if probability_range.values.last != 100000
	
		raise
	
	end

	random = SecureRandom.random_number(99999)

	obtain_monster_id = 0
	probability_range.each do |key, val|
	
		if random < val then
		
			obtain_monster_id = key
			
			break
			
		end
	
	end

	return obtain_monster_id

end


end





